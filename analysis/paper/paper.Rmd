---
title: "Title Goes Here"
author:
  - Yichun Chen:
      email: yichun33@uw.edu
      institute: [UofO]
      correspondence: true
  - Ben Marwick:
      email: fl@another.edu
      institute: [UofA]
      correspondence: false
institute:
  - UofO: University of One Place
  - UofA: University of Another Place
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::word_document2:
      fig_caption: yes
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
      pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
abstract: |
  Text of abstract
keywords: |
  keyword 1; keyword 2; keyword 3
highlights: |
  These are the highlights. 
---


<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/",
  dpi = 300
)
```

# Introduction

Here is a citation [@Marwick2017]

Gender under-representation and inequality has long existed, from under-representation in children’s picture books to academic publications (Hamilton et al. 2006; Tushingham et al. 2017). When talking about inequality in academic fields, we usually refer to the disproportionality between men and women in the field, including archaeology. Women are often underrepresented due to the lack of support women receive in academic fields (Xu 2008). When focusing on the field of archaeology, we can see that gender imbalance still occurs in archaeology and that seems to impact the kind of publications that are done in the field (Bardolph et al. 2016). As we can see in the authorship of the main authors from the Journal of Field Archaeology, 78% of them are men (Heath-Stout 2020). When looking at gender ratios among the membership in Society for California Archaeology from 1967 to 2016, Tushingham et al. (2017) report a trend of women increasingly maintaining their society membership and the gender gap is almost gone. In this study we investigate gender ratios of presenters at major archaeological conferences. We extend the work of Tushingham et al. (2017) with a study of gender ratios of presenters at meetings of the Society of American Archaeology (SAA, 2016-2019), the European Association of Archaeologists (EAA, 2018) and the Computer Applications and Quantitative Methods in Archaeology (CAA, 2017)  We explore how gender ratios vary over time and between these conferences. We examine the influence of the gender of the presenter on the topics that they present on.

# Background



```{r}
# CTRL + OPTION + i to insert a code block
library(here)
SAA16 <- readxl::read_excel(here("analysis/data/SAA2016.xlsx"))
SAA17 <- readxl::read_excel(here("analysis/data/SAA2017.xlsx"))
SAA18 <- readxl::read_excel(here("analysis/data/SAA2018-finalprogram.xlsx"))
SAA19 <- readxl::read_excel(here("analysis/data/SAA2019.xlsx"))
EAA18 <- readxl::read_excel(here("analysis/data/2018 EAA.xlsx"))
CAA18 <- readxl::read_excel(here("analysis/data/2018 CAA.xlsx"))
SAA18_top_term_plot <- readRDS(here("analysis/data/SAA18 top term plot"))

SAA16_row <- nrow(SAA16)
SAA17_row <- nrow(SAA17)
SAA18_row <- nrow(SAA18)
SAA19_row <- nrow(SAA19)
EAA18_row <- nrow(EAA18)
CAA18_row <- nrow(CAA18)

```

# Methods

We collected lists of the people that presented research at recent SAA (2016 with `r SAA16_row` presenters, 2017 with `r SAA17_row` presenters, 2018 with `r SAA18_row` presenters, 2019 with `r SAA19_row` presenters) EAA (2018 with `r EAA18_row` presenters) and CAA (2018 with `r CAA18_row` presenters) conferences. We obtained publicly available programs of these conferences and also tidied the data into a rectangular form with variables including the primary author’s first name, last name and the title of their presentation. We used R and the gender package (Mullen 2018; Mihaljević 2019; Belvis et al. 2015) to predict the gender of all first-named presenters in our sample. We used the gender package to identify a first name as male or female, based on a probability scale computed from government records of name-gender data, specifically US Social Security Administration (SSA) baby name data [citation]. This method has the advantage of speed and ease of automation, but also some substantial limitations. We are only able to infer gender into binary male/female genders and assign probabilities for the first names into these categories. This has the unfortunate result of excluding other genders from the results, and we encourage conference organizers to collect gender data directly from participants to improve the representation of minority genders in future studies. The package often fails to classify non-English names, as the SSA data the package uses are mostly in English names. This means that people with non-English names are underrepresented in our results. To remove names where gender is ambiguous, which we define as a similar proportion of males and females having that name in the SSA data, we excluded names where the difference in proportions was less than 0.47, a figure we obtained by exploratory data analysis. It is important to note that the gender designations here are not self-identified by the presenters, but are computed probabilistically. Better quality data will come if presenters self-identify their gender, but we have no alternative because currently these data are not available. Our hope is that this work, despite its many limitations, will stimulate the collection of more reliable, justifiable, and useful data by conference organisers. 

We are also interested in whether there is a variation in topic choices between the two biological genders in archaeological conferences. To do this we have used the process of topic modeling, which is used to find natural groups of words when we do not have a specific criteria or simply unsure what we are looking for. There are many ways to accomplish topic modeling, we have used the method of Latent Dirichlet allocation (LDA). This method is beneficial in our case because LDA does not treat one topic, which consists of many words, as separate from another topic. Before we can start using LDA, we have to first decide on the number of topics in our collection of texts. To do this we have used the R package ldatuning (add citation), which allows us to use multiple methods to compute an optimal number of groups for LDA processing. We then create a topic model for all our texts, this will assign all words in every document into topics, and assign each word a probability based on its per-topic-per-word probability, which we call beta. After this we keep only the top 10 words within each topic as keywords to represent each topic. Below is an example of a plot for the 2018 SAA that shows the predetermined number of groups each with top ten keywords in each group. From this we then have top terms from the topics of all conferences. We are only interested in keywords that are meaningful in a topic, therefore we have excluded words that are common in the field of archaeology or simply meaningless, for example, the, a, el, al, archaeology...etc. After figuring out the top terms, we can combine them with our earlier exploration of gender to see if one gender seems to favor another, for example if female or male favor topics about 'rock'.

```{r}
SAA18_top_term_plot
```

```{r}
#SAA2018 Topic Model
d <- readxl::read_excel("2018 SAA Title.xlsx")

library(tidyverse)
library(tidytext)

d_word <- d %>%
  unnest_tokens(word, AbstractTitle)

write.table(d_word, "d.xlsx")

word_counts <- d_word %>%
  anti_join(stop_words) %>%
  filter(!word %in% c("de", "la", "el", "los", "user", "archaeology", "archaeological"
                      ,"site", "archaic", "sites")) %>%
  filter(!str_detect(word, "\\d")) %>%
  filter(str_length(word) >= 3) %>%
  filter(!str_detect(word, "\\.|'|\\<U")) %>%
  unite(unique_id, SessionNumber, LastName, FirstName) %>%
  count(unique_id, word, sort = TRUE) %>%
  ungroup()

word_counts

unique_id_dtm <- word_counts %>%
  cast_dtm(unique_id, word, n)

# unique_id_dtm
# library(ldatuning)
# result <- FindTopicsNumber(
#   unique_id_dtm,
#   topics = seq(from = 2, to = 500, by = 1x``),
#   metrics = c("Griffiths2004", "CaoJuan2009", "Arun2010", "Deveaud2014"),
#   method = "Gibbs",
#   control = list(seed = 77),
#   mc.cores = 2L,
#   verbose = TRUE
# )
# 
# FindTopicsNumber_plot(result)

library(topicmodels)
unique_id_lda <- LDA(unique_id_dtm, k = 21, control = list(seed = 1234))
unique_id_lda
saveRDS(unique_id_lda, file = "lda")


chapter_topics <- tidy(readRDS("lda"), matrix = "beta")
chapter_topics

top_terms <- chapter_topics %>%
  group_by(topic) %>%
  top_n(10, beta) %>%
  ungroup() %>%
  arrange(topic, -beta)
top_terms

library(ggplot2)
top_terms_plot <-
top_terms %>%
  mutate(term = reorder_within(term, beta, topic)) %>%
  ggplot(aes(term, beta, fill = factor(topic))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free") +
  coord_flip() +
  scale_x_reordered() 
saveRDS(top_terms_plot, file = "SAA18 top term plot")

unique_id_gamma <- tidy(readRDS("lda"), matrix = "gamma")
unique_id_gamma

unique_id_gamma <- unique_id_gamma %>%
  separate(document, c("SessionNumber", "LastName", "FirstName"), sep = "_", convert = TRUE)
unique_id_gamma
saveRDS(unique_id_gamma, file = "gamma")


#002

# read in data
library(tidyverse)
library(readxl)
saa2018 <- read_excel("2018 SAA Title.xlsx")

total_sessions_in_conf <- 338 # Look in the PDF

# clean up exotic symbols
# from http://stackoverflow.com/a/17517674/1036500
fromto <- read.table(text="
                     from to
                     Å¡ s
                     Å oe
                     Å¾ z
                     Ã ss
                     Ã¾ y
                     Ã th
                     Ã  a
                     Ã¡ a
                     Ã¢ a
                     Ã£ a
                     Ã¤ a
                     Ã¥ a
                     Ã¦ ae
                     Ã§ c
                     Ã¨ e
                     Ã© e
                     Ãª e
                     Ã« e
                     Ã E
                     Ã¬ i
                     Ã� i
                     Ã® i
                     Ã¯ i
                     Ã° d
                     Ã± n
                     Ã² o
                     Ã³ o
                     Ã´ o
                     Ãµ o
                     Ã¶ o
                     Ã¸ oe
                     Ã¹ u
                     Ãº u
                     Ã» u
                     Ã¼ u
                     Ã½ y
                     Ã¿ y
                     Ä g
                     ",header=TRUE)
# Then the function:

replace_foreign_chars <- function(dat,fromto) {
  for(i in 1:nrow(fromto) ) {
    dat <- gsub(fromto$from[i],fromto$to[i],dat)
  }
  dat
}

# tidy up accents and foreign characters
saa2018$`first-named speaker` <- replace_foreign_chars(saa2018$FirstName, fromto)

# extract first name
require("Hmisc")
library(purrr)
first_word_safe <- safely(first.word)

saa2018$first_name <- 
  map(saa2018$FirstName, first_word_safe) %>% 
  map(., c(1)) %>% 
  flatten_chr()

# fill down on session numbers because I only numbered the first speaker in each session.
library(tidyr)
saa2018 <- fill(saa2018, SessionNumber) 

# remove dupicate names in each session 
saa2018 <- 
  saa2018 %>% 
  group_by(SessionNumber) %>% 
  distinct(FirstName, .keep_all = TRUE )

# compute gender of first name
library(gender)
library(dplyr)

# make a safe function so we get a result even if it's an error
gender_safe <-  safely(gender)

# identify the gender of each first nane, this may take a few moments...
saa2018_genders <- 
  saa2018  %>% 
  # hold out name col to use it to make list-col
  nest(-LastName,-SessionNumber) %>%
  # compute genders and store results in list-col
  mutate(first_name_gender = map(data, 
                                 ~gender_safe(.x$`first-named speaker`))) 
saveRDS(saa2018_genders, "gender")

# Ignoring error list, just looking at the result list with gender
saa2018_genders_unnest <-  
  readRDS("gender") %>% 
  mutate(speaker_gender = transpose(first_name_gender)[['result']]) %>% 
  unnest_legacy(speaker_gender) %>% 
  select(SessionNumber,gender, LastName, name)
saveRDS(saa2018_genders_unnest, "gender unnest")

# compute gender ratio overall and for each session
overall_gender_tally_plot<-
  saa2018_genders_unnest %>% 
  group_by(gender) %>% 
  tally() 

#003
library(dplyr)
library(tidyverse)
joined_table <-
  left_join(readRDS("gamma"), 
            readRDS("gender unnest"), 
            by = c("FirstName" = "name",
                   "SessionNumber" = "SessionNumber",
                   "LastName" = "LastName"))
saveRDS(joined_table, "final table")

#Making table similar to Stats Rethinking
joined_table_wider <-
joined_table %>%
  pivot_wider(names_from = "topic", 
              values_from = "gamma")
  
old_names <- names(joined_table_wider)[5:25]
new_names <- paste0("topic", old_names)
renamed_joined_table <-
joined_table_wider %>% 
  rename_at(vars(old_names), ~new_names) %>%
  mutate(gender_b = ifelse(gender == "female", 1, 0))


joined_table %>% 
  filter(!is.na(gender)) %>% 
  filter(gamma >= 0.1) %>% 
ggplot(aes(x = as.factor(topic), y = gamma)) +
  geom_boxplot() +
  facet_wrap(~gender, ncol = 1) 


joined_table %>% 
  filter(!is.na(gender)) %>% 
  filter(gamma >= 0.1) %>% 
  mutate(new_gamma = ((gamma - mean(gamma)) / sd(gamma))^(1/2)) %>%
  ggplot(aes(x = as.factor(topic),
             y = new_gamma,
             colour = gender)) +
  geom_boxplot()


joined_table %>% 
  filter(!is.na(gender)) %>% 
  filter(gamma >= 0.1) %>%
  mutate(new_gamma = ((gamma - mean(gamma)) / sd(gamma))^(1/2)) %>%
  filter(!is.nan(new_gamma)) %>%
  mutate_at(vars(topic, gender), 
            as.factor) %>% 
  aov(gamma ~ gender * topic, data = . ) %>%
  summary
 
d <-
  joined_table %>%
  filter(!is.na(gender)) %>% 
 # filter(gamma >= 0.1) %>%
  mutate(new_gamma = ((gamma - mean(gamma)) / sd(gamma))^(1/2)) %>%
  filter(!is.nan(new_gamma)) %>%
  mutate(topic = paste0('topic', topic)) %>%
  select(-gamma) %>%
  pivot_wider(names_from = topic,
              values_from = new_gamma,
              values_fill = list(new_gamma = 0))
joined_d <- left_join(d, readRDS("gamma"))

m5.16 <- map(
  alist(
    gender ~ dbinom( mu , sigma ) ,
    mu <- a + 
      b.t1*topic1 + 
      b.t1*topic1 +
      b.t2*topic2 +
      b.t3*topic3 +
      b.t4*topic4 +
      b.t5*topic5 +
      b.t6*topic6 +
      b.t7*topic7 +
      b.t8*topic8 +
      b.t9*topic9 +
      b.t10*topic10 +
      b.t11*topic11 +
      b.t12*topic12 +
      b.t13*topic13 +
      b.t14*topic14 +
      b.t15*topic15 +
      b.t16*topic16 +
      b.t17*topic17 +
      b.t18*topic18 +
      b.t19*topic19 +
      b.t20*topic20 +
      b.t21*topic21 +
      b.g*gender,
    a ~ dnorm( 0.6 , 10 ) ,
    b.t ~ dnorm( 0 , 1 ) ,
    b.g ~ dnorm( 0 , 1 ) ,
    sigma ~ dunif( 0 , 10 )
  ),
  data=joined_table )
precis(m5.16)

# just a few people
joined_table %>% 
  filter(LastName == "Moss",
         SessionNumber == 130) %>% 
  ggplot( aes(x = as.factor(topic),
             y = gamma)) +
  geom_boxplot()
  




joined_table %>% 
  filter(topic == 4) %>% 
  filter(gamma >= 0.1) %>%
  filter(!is.na(gender)) %>%
  mutate_at(vars(topic, gender), 
            as.factor) %>% 
  t.test(gamma ~ gender, data=.)
  
  
  ggplot( aes(x = as.factor(topic),
              y = gamma,
              colour = gender)) +
  geom_boxplot()


fit <- glm(gender_b ~ topic1 + topic2 + topic3 + topic4 + topic5 + topic6 +
             topic7 + topic8 + topic9 + topic10 + topic11 + topic12 + topic13 +
             topic14 + topic15 + topic16 +topic17 + topic18 +topic19 +
             topic20 +topic21, data = renamed_joined_table, family = binomial())
summary(fit)

```

# Results

```{r get-data, eval = FALSE}
# Note the path that we need to use to access our data files when rendering this document
# my_data <- read.csv(here::here('analysis/data/raw_data/my_csv_file.csv'))
```



```{r demo-plot, fig.cap="A plot of random numbers"}
plot(rnorm(10))
```

Figure \@ref(fig:demo-plot) shows how we can have a caption and cross-reference for a plot

```{r demo-inline-code}
x <- round(pi, 2)
```

Here is an example of inline code `r x` in the middle of a sentence. 

# Discussion

# Conclusion

# Acknowledgements

<!-- The following line inserts a page break  -->
\newpage

# References 
<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>

\newpage

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies: 

```{r colophon, cache = FALSE}
# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:
u
```{r}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```
